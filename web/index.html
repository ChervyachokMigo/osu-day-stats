<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">

    <script src="jquery.min.js"></script>

    <script>
    $(document).ready(function(){
        $.post('/get_daily_stats', (stats_json)=> {
            stats_and_scores = JSON.parse(stats_json);
            console.log(stats_and_scores)
            stats = stats_and_scores.stats;
            scores_info = stats_and_scores.scores;

            scores_ids = stats.scores_ids;
            daily = stats;
            lastday_stats = stats.lastday_stats?stats.lastday_stats:undefined;
            daily_count = stats.scores_ids.length;
            lastday_count = lastday_stats?lastday_stats.scores_ids.length:0;

            $('.all_scores').empty();
            for (score of scores_info){
                $('.all_scores').append(score_element(score));
            }
            paint_lastday_compare_text();

            $('.daily').empty();
            $('.daily').append(`
            <h2>Daily stats</h2>
            <div class="topic">
                <div class="daily_headers">
                    <div class="headers_title"><B>Title</B></div>
                    <hr>
                    <div class="headers_efficiency"><B>Efficiency</B></div>
                    <div class="headers_pp"><B>Total PP</B></div>
                    <div class="headers_avg_pp"><B>PP per FC</B></div>
                    <div class="headers_count"><B>FC count</B></div>
                    <div class="headers_stars"><B>Average stars</B></div>
                    <div class="headers_accuracy"><B>Average accuracy</B></div>
                    <div class="headers_combo"><B>Average combo</B></div>
                    <div class="headers_length"><B>Average length</B></div>
                    <div class="headers_max_pp"><B>Max PP</B></div>
                    <div class="headers_max_combo"><B>Max combo</B></div>
                    <div class="headers_max_length"><B>Max length</B></div>
                    <div class="headers_max_stars"><B>Max_stars</B></div>
                    <div class="headers_profile_rank"><B>Global rank</B></div>
                    <div class="headers_profile_country_rank"><B>Country rank</B></div>
                    <div class="headers_profile_pp"><B>Profile PP</B></div>
                    <div class="headers_profile_accuracy"><B>Profile accuracy</B></div>
                    <div class="headers_profile_hits"><B>Total hits</B></div>
                    <div class="headers_profile_playcount"><B>Total playcount</B></div>
                    <div class="headers_profile_playtime"><B>Total playtime</B></div>
                </div>
                <div class="today_daily">
                    <div class="daily_title"><B>Today</B></div>
                    <hr>
                    <div class="daily_efficiency">${daily.fc_efficiency}</div>
                    <div class="daily_pp">${Math.floor(daily.total_pp)} pp</div>
                    <div class="daily_avg_pp">${daily_count>0?Math.floor(daily.total_pp/daily_count):0} pp</div>
                    <div class="daily_count">${daily_count}</div>
                    <div class="daily_stars">${daily.avg_stars} ★</div>
                    <div class="daily_accuracy">${daily.avg_accuracy}%</div>
                    <div class="daily_combo">${Number(daily.avg_combo).toFixed(0)}x</div>
                    <div class="daily_length">${format_seconds(daily.avg_length)}</div>
                    <div class="daily_max_pp">${Math.floor(daily.max_pp)}</div>
                    <div class="daily_max_combo">${daily.max_combo}x</div>
                    <div class="daily_max_length">${format_seconds(daily.max_length)}</div>
                    <div class="daily_max_stars">${daily.max_stars} ★</div>
                    <div class="daily_profile_rank">#${daily.profile_last_update.rank}</div>
                    <div class="daily_profile_country_rank">#${daily.profile_last_update.country_rank}</div>
                    <div class="daily_profile_pp">${Math.floor(daily.profile_last_update.pp)} pp</div>
                    <div class="daily_profile_accuracy">${daily.profile_last_update.accuracy.toFixed(2)}%</div>
                    <div class="daily_profile_hits">${daily.profile_last_update.hits}</div>
                    <div class="daily_profile_playcount">${daily.profile_last_update.playcount}</div>
                    <div class="daily_profile_playtime">${format_date(daily.profile_last_update.playtime)}</div>
                </div>
                <div class="lastday_stats">
                    <div class="lastday_title"><B>Lastday compare</B></div>
                    <hr>
                    <div class="lastday_efficiency">${lastday_stats? ''+ make_sign((Number(daily.fc_efficiency) - Number(lastday_stats.fc_efficiency)).toFixed(2)):''}</div>
                    <div class="lastday_pp">${lastday_stats? ''+ make_sign((Number(daily.total_pp) - Number(lastday_stats.total_pp)).toFixed(2)) + ' pp':''}</div>
                    <div class="lastday_avg_pp">${lastday_stats? ''+ daily_count>0?make_sign(Number((daily.total_pp/daily_count - lastday_stats.total_pp/lastday_count).toFixed(2))) + ' pp':'0 pp':''}</div>
                    <div class="lastday_count">${lastday_stats? ''+ make_sign((Number(daily_count) - Number(lastday_count)).toFixed(0)):''}</div>
                    <div class="lastday_stars">${lastday_stats? ''+ make_sign((Number(daily.avg_stars) - Number(lastday_stats.avg_stars)).toFixed(2)) + ' ★':''}</div>
                    <div class="lastday_accuracy">${lastday_stats? ''+ make_sign((Number(daily.avg_accuracy) - Number(lastday_stats.avg_accuracy)).toFixed(2)) + '%':''}</div>
                    <div class="lastday_combo">${lastday_stats? ''+ make_sign(Number((Number(daily.avg_combo) - Number(lastday_stats.avg_combo))).toFixed(0)) + 'x':''}</div>
                    <div class="lastday_length">${lastday_stats? make_sign(Number(daily.avg_length) - Number(lastday_stats.avg_length), true) + ''+ format_seconds((Number(daily.avg_length) - Number(lastday_stats.avg_length))):''}</div>
                    <div class="lastday_max_pp">${lastday_stats? make_sign( daily.max_pp - lastday_stats.max_pp ) + ' pp':''}</div>
                    <div class="lastday_max_combo">${lastday_stats? make_sign( daily.max_combo - lastday_stats.max_combo ) + 'x':''}</div>
                    <div class="lastday_max_length">${lastday_stats? make_sign( format_seconds(daily.max_length - lastday_stats.max_length) ):''}</div>
                    <div class="lastday_max_stars">${lastday_stats? make_sign( daily.max_stars - lastday_stats.max_stars ) + ' ★':''}</div>
                    <div class="lastday_profile_rank">${lastday_stats? make_sign(-(daily.profile_last_update.rank - lastday_stats.profile_last_update.rank)):''}</div>
                    <div class="lastday_profile_country_rank">${lastday_stats? make_sign(-(daily.profile_last_update.country_rank - lastday_stats.profile_last_update.country_rank)):''}</div>
                    <div class="lastday_profile_pp">${lastday_stats? make_sign(Math.floor(daily.profile_last_update.pp - lastday_stats.profile_last_update.pp)):''} pp</div>
                    <div class="lastday_profile_accuracy">${lastday_stats? make_sign(daily.profile_last_update.accuracy - lastday_stats.profile_last_update.accuracy):''}%</div>
                    <div class="lastday_profile_hits">${lastday_stats? make_sign(daily.profile_last_update.hits - lastday_stats.profile_last_update.hits):''}</div>
                    <div class="lastday_profile_playcount">${lastday_stats? make_sign(daily.profile_last_update.playcount - lastday_stats.profile_last_update.playcount):''}</div>
                    <div class="lastday_profile_playtime">${lastday_stats? make_sign(daily.profile_last_update.playtime - lastday_stats.profile_last_update.playtime):''}</div>
                </div>
            </div>`);
            
            $('.loading').hide();
            $('.daily').toggleClass('flex', true);
        });
    });

    function score_element(score){
        var el = `<div class="score_element">
                <div class="score_bg">
                    <div class="score_bg_picture"><img src="${score.beatmap_bg}"></div>
                    <div class="score_bg_preview_play">
                        <audio src="https:${score.beatmap_preview}" loop="true" preload="none"></audio>
                        <button class="play-button" onclick="playAudio($(this))"><img src="play.png"></button>
                    </div>
                </div>
                <div class="score_info">
                    <div class="score_title"><a href=${score.beatmap_url}>${score.beatmap_title}</a></div>
                    <hr>
                    <div class="score_stats">
                        <div class="score_efficiency"><b>Efficiency:</b> ${(score.fc_efficiency).toFixed(2)}</div>
                        <div class="beatmap_length"><b>PP: </b> ${score.pp}</div>
                        <div class="score_combo"><b>Combo:</b> ${score.combo}/${score.max_combo}x</div>
                        <div class="score_accuracy"><b>Accuracy:</b> ${(score.accuracy*100).toFixed(2)}%</div>
                        <div class="beatmap_stars"><b>Stars:</b> ${(score.stars).toFixed(2)}★</div>
                        <div class="beatmap_length"><b>Length:</b> ${format_seconds(score.beatmap_length)}</div>
                    </div>
                </div>  
            </div>`;
        return el;
    }

    function paint_lastday_compare_text(){
        $('.lastday_stats').find('*').each((i, el)=>{
            if (el.textContent.slice(0,1) === '+'){
                $(el).toggleClass('positive');
            }
            if (el.textContent.slice(0,1) === '-'){
                $(el).toggleClass('negative');
            }
        })
    }

    function format_seconds(seconds) {
        var minutes = Math.floor(seconds / 60);
        var secondsRemainder = Math.abs(seconds % 60);
        return minutes + ":" + (secondsRemainder < 10 ? "0" : "") + secondsRemainder;
    }

    function format_date(date_number){
        const date_days = date_number / 24 / 60 / 60;
        const days = Math.trunc( date_days );
        const date_hours = (date_days - days) / 0.0416667;
        const hours = Math.trunc( date_hours );
        const minutes = Math.trunc((date_hours - hours) / 0.0166667);
        return `${days>0?days + 'd ':''}${hours>0?hours + 'h ':''}${minutes>0?minutes + 'm':''}`;
    }

    function playAudio(el) {
        
        for (let img of $('.score_bg_preview_play').find('img')){
            $(img).attr("src", "play.png");
        }
        var audio = $(el).parent('.score_bg_preview_play').children('audio')[0];

        if (audio.paused) {
            document.querySelectorAll('audio').forEach(el => {
                el.currentTime = 0;
                el.pause()});
            audio.play();
            $(el).children('img').attr("src", "pause.png");
        } else {
            audio.pause();
            $(el).children('img').attr("src", "play.png");
        }
    }

    function make_sign(num, only_sign = false){
        if (only_sign) {
            if (Number(num)>0) return '+';
            return '';
        }
        if (Number(num)>0) return '+'+num;
        return num;
    }

    </script>

    <link rel="stylesheet" href="styles.css">
    <title>Recent scores</title>
</head>

<body>
    <div class="daily"></div>
    <div class="all_scores">
        <div class="loading">loading...</div>
    </div>
</body>

</html>
